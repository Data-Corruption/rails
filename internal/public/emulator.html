<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rails</title>
  <link href="/public/css/output.css" rel="stylesheet">
  <script>
    const themeChangeCallbacks = [];
    if (!localStorage.getItem('theme')) localStorage.setItem('theme', 'dark') // default to dark theme
    document.documentElement.setAttribute('data-theme', localStorage.getItem('theme')) // set theme on page load
    window.setTheme = function (theme) {
      localStorage.setItem('theme', theme)
      document.documentElement.setAttribute('data-theme', theme)
      themeChangeCallbacks.forEach(cb => cb(theme))
    }
    window.onThemeChange = function (cb) {
      themeChangeCallbacks.push(cb)
    }
  </script>
</head>

<body class="h-dvh flex flex-col">
  <!-- navbar -->
  <div class="navbar bg-base-300">
    <div class="navbar-start h-full">
      <a href="/" class="h-full flex flex-row space-x-2">
        <img id="logo" class="h-full" src="" alt="logo" />
        <script>
          const logo = document.getElementById('logo')
          logo.src = localStorage.getItem('theme') === 'dark' ? '/public/logo-darkmode.png' : '/public/logo-lightmode.png'
          window.onThemeChange(theme => {
            const logo = document.getElementById('logo')
            logo.src = theme === 'dark' ? '/public/logo-darkmode.png' : '/public/logo-lightmode.png'
          })
        </script>
        <span class="self-center font-semibold tracking-wide font-ProggyVector whitespace-nowrap">Rails</span>
      </a>
    </div>
    <div class="navbar-end">
      <label class="swap swap-rotate h-full ml-4">
        <input id="dark-mode-btn" type="checkbox" />
        <script>
          const darkModeBtn = document.getElementById('dark-mode-btn')
          darkModeBtn.checked = localStorage.getItem('theme') === 'dark'
          darkModeBtn.addEventListener('change', () => {
            setTheme(darkModeBtn.checked ? 'dark' : 'light')
          })
        </script>
        <!-- sun icon -->
        <svg class="swap-off h-10 w-10 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path
            d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z" />
        </svg>
        <!-- moon icon -->
        <svg class="swap-on h-10 w-10 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path
            d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z" />
        </svg>
      </label>
    </div>
  </div>
  <!-- main contents -->
  <div class="w-full flex-grow flex flex-col 2xl:flex-row space-y-4 2xl:space-y-0 2xl:space-x-4 p-4">
    <div class="w-[600px] h-full bg-base-200 rounded p-4 flex flex-col space-y-4">
      <h3 class="font-bold text-lg">Assembly</h3>
      <div class="flex flex-row mb-2 space-x-2">
        <button class="btn btn-sm btn-primary" onclick="loadAssembly()">Load</button>
        <button class="btn btn-sm btn-primary" onclick="saveAssembly()">Save</button>
        <button class="btn btn-sm btn-primary" onclick="flashAssembly()">Flash Program ROM</button>
      </div>
      <div id="editor" class="flex-grow"></div> <!-- height issue on vertical mode -->
      <script src="/public/ace/ace.js" type="text/javascript" charset="utf-8"></script>
      <script src="/public/ace/rails_assembly_highlight_rules.js" type="text/javascript" charset="utf-8"></script>
      <script src="/public/ace/mode-rails_assembly.js" type="text/javascript" charset="utf-8"></script>
      <script>
        ace.config.set("basePath", "/public/ace");
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/github_dark");
        editor.session.setMode("ace/mode/rails_assembly");
      </script>
    </div>
    <div class="w-[600px] h-full bg-base-200 rounded p-4">
      <h3 class="font-bold text-lg">Controls</h3>
      <div class="flex flex-row mb-2 space-x-2">
        <button class="btn btn-sm btn-primary" onclick="start()">Start</button>
        <button class="btn btn-sm btn-primary" onclick="stop()">Stop</button>
        <button class="btn btn-sm btn-primary" onclick="step()">Step</button>
        <button class="btn btn-sm btn-primary" onclick="reset()">Reset</button>
      </div>
      <!-- start, stop, step, reset, and pc / carry reg -->
      <h3 class="font-bold text-lg">I/O registers</h3>
      <div class="flex flex-row mb-2 space-x-2">
        <div class="font-semibold text-center flex items-center justify-center">Address:</div>
        <input id="io_in_address" type="number" max="255" min="0" placeholder="0"
          class="input input-bordered max-h-8 max-w-16" />
        <div class="font-semibold text-center flex items-center justify-center">Value:</div>
        <input id="io_in_value" type="number" max="255" min="0" placeholder="0"
          class="input input-bordered max-h-8 max-w-16" />
        <button class="btn btn-sm btn-primary" onclick="setIoReg()">Set</button>
      </div>
      <div id="ioregs" class="grid grid-cols-16 gap-1"></div>
      <script>
        /* Example:
        <div class="tooltip w-8 h-16 bg-base-100 flex flex-col rounded" data-tip="0x00" data-address=0>
          <div class="inreg basis-1/2 text-center flex items-center justify-center">value</div>
          <div class="outreg basis-1/2 text-center flex items-center justify-center">value</div>
        </div>
        */
        function genIoCell(address) {
          const cell = document.createElement('div')
          cell.classList.add('tooltip', 'w-8', 'h-16', 'bg-base-100', 'flex', 'flex-col', 'rounded')
          cell.dataset.tip = `0x${address.toString(16).padStart(2, '0')}`
          cell.dataset.address = address
          const inreg = document.createElement('div')
          inreg.classList.add('inreg', 'basis-1/2', 'text-center', 'flex', 'items-center', 'justify-center')
          inreg.textContent = '0'
          const outreg = document.createElement('div')
          outreg.classList.add('outreg', 'basis-1/2', 'text-center', 'flex', 'items-center', 'justify-center')
          outreg.textContent = '0'
          cell.appendChild(inreg)
          cell.appendChild(outreg)
          return cell
        }

        const ioregs = document.getElementById('ioregs')
        for (let i = 0; i < 16; i++) {
          ioregs.appendChild(genIoCell(i))
        }
      </script>
    </div>
    <div class="w-[600px] h-full bg-base-200 rounded p-4 space-y-4">
      <h3 class="font-bold text-lg">Register file</h3>
      <div id="regfile" class="grid grid-cols-16 gap-1"></div>
      <h3 class="font-bold text-lg">Memory</h3>
      <div id="memory" class="grid grid-cols-16 gap-1"></div>
      <script>
        // Example: <div class="tooltip w-8 h-8 bg-base-100 text-center flex items-center justify-center rounded" data-tip="0x00" data-address=0>value</div>
        function genCell(address) {
          const cell = document.createElement('div')
          cell.classList.add('tooltip', 'w-8', 'h-8', 'bg-base-100', 'text-center', 'flex', 'items-center', 'justify-center', 'rounded')
          cell.dataset.tip = `0x${address.toString(16).padStart(2, '0')}`
          cell.dataset.address = address
          cell.textContent = '0'
          return cell
        }

        // generate regfile
        const regfile = document.getElementById('regfile')
        for (let i = 0; i < 16; i++) {
          regfile.appendChild(genCell(i))
        }
        // switch 0 reg bg to base-300 to indicate it's a constant 0
        regfile.children[0].classList.remove('bg-base-100')
        regfile.children[0].classList.add('bg-base-300')

        // generate memory
        const memory = document.getElementById('memory')
        for (let i = 0; i < 256; i++) {
          memory.appendChild(genCell(i))
        }
      </script>
    </div>

  </div>

</body>

</html>