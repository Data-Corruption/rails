<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rails</title>
  <link href="/public/css/output.css" rel="stylesheet">
  <script>
    if (!localStorage.getItem('theme')) localStorage.setItem('theme', 'dark') // default to dark theme
    document.documentElement.setAttribute('data-theme', localStorage.getItem('theme')) // set theme on page load

    async function assemble(assembly) {
      const assemblyRes = await fetch('/api/assemble', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          assembly: assembly
        })
      });
      if (!assemblyRes.ok) {
        const errorText = await assemblyRes.text();
        throw new Error(errorText || 'An error occurred');
      }
      const assemblyJson = await assemblyRes.json();
      const convertedBin = assemblyJson.binary.map(str => BigInt(str))
      return convertedBin
    }
  </script>
</head>

<body class="max-w-[1865px]">
  <div class="w-full max-h-screen flex flex-col 2xl:flex-row space-y-4 2xl:space-y-0 2xl:space-x-4 p-4">

    <!-- panel one -->
    <div class="w-[600px] max-h-[1200px] 2xl:grow bg-base-200 rounded p-4 flex flex-col space-y-4">
      <h3 class="font-bold text-lg">Assembly</h3>
      <div class="flex flex-row mb-2 space-x-2">
        <button class="btn btn-sm btn-primary" onclick="loadAssembly()">Load</button>
        <button class="btn btn-sm btn-primary" onclick="saveAssembly()">Save</button>
        <button class="btn btn-sm btn-primary" onclick="flashAssembly()">Flash Program ROM</button>
      </div>
      <div id="editor" class="h-[1200px] 2xl:h-auto 2xl:grow"></div> <!-- height issue on vertical mode -->
      <script src="/public/ace/ace.js" type="text/javascript" charset="utf-8"></script>
      <script src="/public/ace/rails_assembly_highlight_rules.js" type="text/javascript" charset="utf-8"></script>
      <script src="/public/ace/mode-rails_assembly.js" type="text/javascript" charset="utf-8"></script>
      <script>
        ace.config.set("basePath", "/public/ace");
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/github_dark");
        editor.session.setMode("ace/mode/rails_assembly");

        async function flashAssembly() {
          const assembly = editor.getValue()
          const binary = await assemble(assembly)
          loadProgramROM(binary)
        }
      </script>
    </div>

    <!-- panel two -->
    <div class="w-[600px] max-h-[1200px] 2xl:grow bg-base-200 rounded p-4 flex flex-col space-y-4">
      <h3 class="font-bold text-lg">Controls</h3>
      <div class="flex flex-row mb-2 space-x-2">
        <button class="btn btn-sm btn-primary" onclick="start()">Start</button>
        <button class="btn btn-sm btn-primary" onclick="stop()">Stop</button>
        <button class="btn btn-sm btn-primary" onclick="step()">Step</button>
        <button class="btn btn-sm btn-primary" onclick="reset()">Reset</button>
        <div class="divider divider-vertical"></div>
        <!-- pc stuff -->
      </div>
      <h3 class="font-bold text-lg">Program ROM</h3>
      <div id="program" class="flex flex-col h-full overflow-y-scroll space-y-1"></div>
      <div class="hidden p-0 m-0"></div>
      <script>
        /* Example:
        <div class="flex flex-row w-full h-8 bg-base-100 rounded items-center justify-around" data-address=0>
          <span class="text-center flex items-center justify-center font-bold">address number here e.g "000:"</div>
          <span class="text-center flex items-center justify-center" data-bitIndex=0>0</div>
          <span class="text-center flex items-center justify-center" data-bitIndex=1>0</div>
          <span class="text-center flex items-center justify-center" data-bitIndex=2>0</div>
          <span class="text-center flex items-center justify-center" data-bitIndex=3>0</div>
          <span class="text-center flex items-center justify-center">-</div>
          repeat the above content 3 more times, minus the address span and the div on the last one...
        </div>
        */
        function genPromInstruction(address) {
          const cell = document.createElement('div')
          cell.classList.add('flex', 'flex-row', 'w-full', 'h-8', 'bg-base-100', 'rounded', 'items-center', 'justify-around')
          cell.dataset.address = address
          const addressSpan = document.createElement('span')
          addressSpan.classList.add('text-center', 'flex', 'items-center', 'justify-center', 'font-bold')
          addressSpan.textContent = `${address.toString(10).padStart(3, '0')}:`
          cell.appendChild(addressSpan)
          for (let i = 0; i < 16; i++) {
            const bitSpan = document.createElement('span')
            bitSpan.classList.add('text-center', 'flex', 'items-center', 'justify-center')
            bitSpan.dataset.bitIndex = i
            bitSpan.textContent = '0'
            cell.appendChild(bitSpan)
            if (i % 4 === 3 && i !== 15) {
              const divider = document.createElement('span')
              divider.classList.add('text-center', 'flex', 'items-center', 'justify-center')
              divider.textContent = '-'
              cell.appendChild(divider)
            }
          }
          return cell
        }

        const program = document.getElementById('program')
        for (let i = 0; i < 256; i++) {
          program.appendChild(genPromInstruction(i))
        }

        // set to -1 to clear all highlights
        function highlightInstruction(address) {
          const cells = program.children
          for (let i = 0; i < cells.length; i++) {
            const cell = cells[i]
            if (parseInt(cell.dataset.address) === address) {
              cell.classList.add('-hue-rotate-60')
              // cell.scrollIntoView({ behavior: 'smooth', block: 'center' })
            } else {
              cell.classList.remove('-hue-rotate-60')
            }
          }
        }

        // instructions is a 256 length array of BigInts
        function loadProgramROM(instructions) {
          const cells = program.children
          for (let i = 0; i < cells.length; i++) {
            const cell = cells[i]
            const instruction = i < instructions.length ? instructions[i] : 0n
            for (let j = 0; j < 16; j++) {
              const bitSpan = cell.querySelector(`span[data-bit-index="${15 - j}"]`)
              bitSpan.textContent = instruction & (1n << BigInt(j)) ? '1' : '0'
            }
          }
        }

        highlightInstruction(0)
      </script>
    </div>

    <!-- panel three -->
    <div class="w-[600px] max-h-[1200px] 2xl:grow bg-base-200 rounded p-4 space-y-4">
      <h3 class="font-bold text-lg">I/O registers</h3>
      <div class="flex flex-row mb-2 space-x-2">
        <div class="font-semibold text-center flex items-center justify-center">Address:</div>
        <input id="io_in_address" type="number" max="255" min="0" placeholder="0"
          class="input input-bordered max-h-8 max-w-16" />
        <div class="font-semibold text-center flex items-center justify-center">Value:</div>
        <input id="io_in_value" type="number" max="255" min="0" placeholder="0"
          class="input input-bordered max-h-8 max-w-16" />
        <button class="btn btn-sm btn-primary" onclick="setIoReg()">Set</button>
        <!-- add reset io btn -->
      </div>
      <div id="ioregs" class="grid grid-cols-16 gap-1"></div>
      <script>
        /* Example:
        <div class="tooltip w-8 h-16 bg-base-100 flex flex-col rounded" data-tip="0x00" data-address=0>
          <div class="inreg basis-1/2 text-center flex items-center justify-center">value</div>
          <div class="outreg basis-1/2 text-center flex items-center justify-center">value</div>
        </div>
        */
        function genIoCell(address) {
          const cell = document.createElement('div')
          cell.classList.add('tooltip', 'w-8', 'h-16', 'bg-base-100', 'flex', 'flex-col', 'rounded')
          cell.dataset.tip = `0x${address.toString(16).padStart(2, '0')}`
          cell.dataset.address = address
          const inreg = document.createElement('div')
          inreg.classList.add('inreg', 'basis-1/2', 'text-center', 'flex', 'items-center', 'justify-center')
          inreg.textContent = '0'
          const outreg = document.createElement('div')
          outreg.classList.add('outreg', 'basis-1/2', 'text-center', 'flex', 'items-center', 'justify-center')
          outreg.textContent = '0'
          cell.appendChild(inreg)
          cell.appendChild(outreg)
          return cell
        }

        const ioregs = document.getElementById('ioregs')
        for (let i = 0; i < 16; i++) {
          ioregs.appendChild(genIoCell(i))
        }
      </script>
      <h3 class="font-bold text-lg">Register file</h3>
      <div id="regfile" class="grid grid-cols-16 gap-1"></div>
      <h3 class="font-bold text-lg">Memory</h3>
      <div id="memory" class="grid grid-cols-16 gap-1"></div>
      <script>
        // Example: <div class="tooltip w-8 h-8 bg-base-100 text-center flex items-center justify-center rounded" data-tip="0x00" data-address=0>value</div>
        function genCell(address) {
          const cell = document.createElement('div')
          cell.classList.add('tooltip', 'w-8', 'h-8', 'bg-base-100', 'text-center', 'flex', 'items-center', 'justify-center', 'rounded')
          cell.dataset.tip = `0x${address.toString(16).padStart(2, '0')}`
          cell.dataset.address = address
          cell.textContent = address.toString(10).padStart(3, '0')
          return cell
        }

        // generate regfile
        const regfile = document.getElementById('regfile')
        for (let i = 0; i < 16; i++) {
          regfile.appendChild(genCell(i))
        }
        // switch 0 reg bg to base-300 to indicate it's a constant 0
        regfile.children[0].classList.remove('bg-base-100')
        regfile.children[0].classList.add('bg-base-300')

        // generate memory
        const memory = document.getElementById('memory')
        for (let i = 0; i < 256; i++) {
          memory.appendChild(genCell(i))
        }

        // -1 to clear highlights for given action
        function updateRegfile(readAddr, writeAddr, writeData) {
          const cells = regfile.children
          for (let i = 0; i < cells.length; i++) {
            const cell = cells[i]
            const address = parseInt(cell.dataset.address)
            // update readAddr
            if (address === readAddr) {
              cell.classList.add('-hue-rotate-90')
            } else {
              cell.classList.remove('-hue-rotate-90')
            }
            // update writeAddr
            if (address === writeAddr) {
              cell.classList.add('-hue-rotate-60')
            } else {
              cell.classList.remove('-hue-rotate-60')
            }
            if (address === writeAddr) {
              cell.textContent = writeData.toString(10)
            }
          }
        }

        // -1 to clear all highlight
        function updateMemory(address, isWrite, data) {
          const cells = memory.children
          for (let i = 0; i < cells.length; i++) {
            const cell = cells[i]
            const cellAddress = parseInt(cell.dataset.address)
            if (cellAddress === address) {
              cell.classList.add(isWrite ? '-hue-rotate-60' : '-hue-rotate-90')
              cell.textContent = data.toString(10)
            } else {
              cell.classList.remove(isWrite ? '-hue-rotate-60' : '-hue-rotate-90')
            }
          }
        }
      </script>
    </div>

  </div>

</body>

</html>